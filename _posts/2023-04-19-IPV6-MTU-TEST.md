---
layout: post
title: 关于路由器 IPV6 MTU 的不专业测试 
categories: [混沌工程]
description: 测试当地宽带运营商 ipv6 MTU 的最佳值
keywords: IPV6, MTU，MSS
---

## 环境
广东联通宽带（粤北）、ipv6、TPlink（桥接）、安卓、Ubuntu

## 测试流程
* 1、安卓端关闭 WIFI。
* 2、清理安卓端 虎X 应用缓存。
* 3、路由器修改 MTU （会自动重拨）
* 4、连接 WIFI，正常访问 6.ipw.cn， speed.neu6.deu.cn 测速，确保手机能正常使用 ipv6。
* 5、通过 X牙 应用的不同类别、订阅直播间画面的缩略图是否正常，网XX 应用是否能正常启动，作为判断依据。
* 6、需长期使用观察，例如我这 MTU 设置 1428 用久了就会「有问题」，不能正常使用 v6。

## 方法
 
 MTU 1500 一直减 2<font color="#0645ad"><sup>[[4]](https://www.v2ex.com/t/920462)</sup></font>，测试出「<font color="#0000dd">可用范围</font>」，而非「<font color="#dd0000">~~最佳值？~~</font>」，网站请务使用自己经常出问题的网站。

* 自用 [Linux 脚本](*)
* 不同网址，不同运营商，不同地区，不同设备可能都有差别！
* ping6 -s < size > packetsize用作要发送的数据字节数 < destination > 网址
* MTU = size + 28

## 结果

<details><summary>测试1</summary>

```bash
ping6 -c 4 -s 1300 www.huya.com
```
--------------------
|   size    |   平均值  |  MTU  |      附     |  路由器 MTU: 1480 |
|   :----:  |   :----: | :----:|   :----:    |   :----:        |            
|   141+    | ~~不通~~  | 1+++ |            |                   |
|   1410    | ~~不通~~  | 1438 |            |                   |
|   1408    | ~~不通~~    | 1436 |            |                   |
|   1406    | ~~不通~~  | 1434 |    多次测试  |     临界线              |
|   1404    |   25.346  | 1432 |    多次测试 |     临界线      |
|   1402    |   25.734  | 1430 |            |                   |
|   1400    |   25.754  | 1428 |            |                   |
|   13XX    |   正常    | 1XXX |             |                   |
|   12XX    |   正常    | 1XXX |             |                   |

--------------------

|   size    |   平均值  |  MTU  |      附    |  路由器 MTU: 1432 |
|   :----:  |   :----:  | :----:|   :----:  |   :----:          |    
|   1386    | ~~不通~~  | 1414 |    多次测试 |     临界线        |
|   1384    | 15.454   | 1412 |     多次测试 |    临界线         |
|   1382    | 16.511   | 1410 |             |                   |

--------------------

|   size    |   平均值  |  MTU  |      附     |  路由器 MTU: 1420 |
|   :----:  |   :----:  | :----:|   :----:    |   :----:        |    
|   1376    | ~~不通~~  | 1404 |             |                   |
|   1374    | ~~不通~~  | 1402 |    多次测试  |     临界线        |
|   1372    |   22.438  | 1400 |    多次测试  |     临界线        |
|   1370    |   22.435  | 1398 |             |                   |
|   1368    |   22.459  | 1396 |             |                   |
|   1366    |   22.393  | 1394 |             |                   |

--------------------

</details>







<details><summary>测试2</summary>

路由器 MTU 1430
```bash
ping6 -s 1300 6.ipw.cn     通
ping6 -s 1200 www.huya.com 通
ping6 -s 1300 www.huya.com 通
ping6 -s 1400 www.huya.com 不通
```
路由器 MTU 1480
```bash
ping6 -s 1404 www.huya.com 通   MTU 为 1430 小于 1404 通
ping6 -s 1480 www.huya.com 不通
ping6 -s 1500 6.ipw.cn     通   
ping6 -s 1500 www.qq.com   通 
ping6 -s 60000 www.qq.com  通   www.qq.com小于 6W    通
```

</details>

以下是路由器 TPlink MTU 设定值
```
1378 1326 1420 1348 1400 1424 1426 1430    完全打不开
143+ 不通 
1434 不通
1432 最佳       # 没问题，可长期使用
1430 正常       # 网XX 应用进不去（广告阻挡）
1428 正常       # 用久了（几小时到几天不等）会上不了 v6 网站，可 ping 通
1426 正常       # 未长时间测试
1420 不通
```




-----------------------------------------
以下是个人心路历程，没有太大参考价值

上年见东莞联通的 v友 说可以拿到公网 v4，就装了联通宽带，喜得 v4/v6 双公，原本电信也有 v6 ，某天就只给 v4 了，因为广东联通出国快，就把主路由设置成联通。
前两个月开始家人抱怨网络慢，主要表现为微信直播号卡顿，加载不出字幕，或者需要等很久才能看到直播，评论区加载不出来。

但是本人又感觉没问题，可能是比较少上国内的网站的缘故，手机（安卓）一般看 B站，虎牙，卡的时候视频直播大部分封面加载不出来，估计等几十秒才能完全加载出来。电脑 WIN10\Debain\Ubuntu 则没有这个问题，最后排查出是 IPV6 出了问题（将近一个多月），现在怀疑是不是那些手机应用前几个月开始广泛使用 ipv6 的缘故，毕竟上年一点问题都没。想保留 ipv6，因为 电信v4/联通v6 要用来 pt 做种，不需要汇聚很方便，主路由断电也会自动开机。

想过的解决思路
1. 禁止安卓端 ipv6

    如果路由器开启 ipv6，安卓(非root) wifi 不能禁止 ipv6 的使用(安卓有点不人道了)，只支持 SLACC（无状态）模式。

2. 利 ipv6 的防火墙

    我的路由器又没有后台(shell)功能，广东联通 ipv6 PD 前缀又只有 /64 ,不能利用旁路由的 ipv6 防火墙。

3. 投诉运营商、网站

    前几天还想着投诉，借口都想好了：联通宽带 ipv6 路由“有问题”，让他们自己查，毕竟联通、移动、电信运营商的 4g/5g 信号是没问题的。

天不时地不利机不和

后来想起 v友 经常提起 ipv6 MTU 黑洞。tp 路由器 MTU 默认 1480，看了很多 MTU 参考值不起作用，反而某些值 1452~1502 会更慢，甚至完全加载不出来，所以更加加深了对 MTU 是「罪魁祸首」的猜疑，它能让网速加载更慢，为什么不能让它更快！然后就开始了测试道路。

路由器用了五六年，也该「换」了，虽然没有任何问题（除了ipv6）。希望 V友 有空的时候专门开贴去炮轰一下厂家，让老设备更新一下固件。还有，大厂硬路由的新设备（最近一两年）还有这些问题吗？

-----------------------------------------


## 参考
附：

- 1.OS修改MTU和MSS解决上网慢和页面显示不全问题 [[详情]](https://danteng.org/ros-change-mtu-mss-solve-page-problems/)
    -  MTU 是 1492，则对应 MSS 是 1492-40=1452（IP 报头 20，TCP 报头 20）
    -  IPv6 MSS 最小是 1280

- 2.开启 IPv6 后网速变得很慢？可能是 PMTU 黑洞的问题 [[详情]](https://www.v2ex.com/t/800024)

- 3.湖北移动 [[详情]](https://www.v2ex.com/t/928381)
    -  @droidmax61： 湖北移动 ppp 接口默认 mtu 是 1492(ipv4)，ipv6 的 mtu 必须设为 1432 才可以正常使用

- 4.讨论御三家运营商的最佳 MTU [[详情]](https://www.v2ex.com/t/920462)
    -  MTU 1500 一直减 2，建议开始从 1452 开始测。固定路由器 MTU 值
    -  ping6 -s 1452 www.huya.com 

- 5.[ikuai] 爱快主路由下 IPV6 防火墙的最优解（可能） [[详情]](https://www.right.com.cn/forum/thread-8277247-1-1.html)
    - PD 前缀需要小于 64，否则 openwrt 无法下发 ipv6 地址



